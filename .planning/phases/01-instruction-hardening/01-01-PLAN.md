---
phase: 01-instruction-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TOOLS.md
autonomous: true

must_haves:
  truths:
    - "Every command in TOOLS.md has a DO/DO NOT table showing correct vs incorrect usage"
    - "Before/after examples demonstrate the most common mistakes cheap LLMs make (timezone, command selection, date format)"
    - "Telegram command handlers include exact parsing examples with input/output for each trigger phrase"
    - "Edge cases are explicitly documented (late-night timezone crossover, ambiguous input, multi-item additions)"
  artifacts:
    - path: "TOOLS.md"
      provides: "Hardened command reference with DO/DO NOT tables and parsing examples"
      contains: "DO NOT"
  key_links:
    - from: "TOOLS.md"
      to: "calendar/calendar.js"
      via: "Command syntax documentation"
      pattern: "node calendar\\.js"
    - from: "TOOLS.md"
      to: "household/*.md"
      via: "File operation documentation"
      pattern: "household/"
---

<objective>
Harden TOOLS.md so cheap LLMs stop making timezone, command selection, and format errors.

Purpose: TOOLS.md is the primary instruction file that agents read every session. Currently it lists commands but does not explicitly show what NOT to do. Cheap models make predictable mistakes (using `date` instead of `node calendar.js now`, using `list` for "today" queries, writing UTC timestamps in notes). Adding explicit DO/DO NOT tables with before/after examples and detailed Telegram parsing examples will prevent these errors.

Output: A significantly expanded TOOLS.md with DO/DO NOT tables for every command section, before/after mistake examples, and Telegram command handlers with exact input parsing and edge case examples.
</objective>

<execution_context>
@/Users/greg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/greg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@TOOLS.md
@calendar/AGENT_INSTRUCTIONS.md
@household/state/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DO/DO NOT tables and before/after examples to every TOOLS.md command section</name>
  <files>TOOLS.md</files>
  <action>
Read the current TOOLS.md thoroughly. For each major section, add a DO/DO NOT table immediately after the command reference. These tables must cover the most common mistakes cheap LLMs make.

**Timezone section** -- Add a DO/DO NOT table:
| DO | DO NOT | WHY |
| `node calendar.js now` to get current date/time | `date` shell command | System clock is UTC; at 10pm Pacific it's already tomorrow in UTC |
| Use `today` for "what's happening today" | Use `list` for "today" queries | `list` starts from UTC now, doesn't cap at end-of-day Pacific |
| Pass bare `YYYY-MM-DDTHH:MM:SS` to `add` | Add timezone suffix like `Z` or `-08:00` | CLI adds Pacific timezone automatically; adding suffix causes double-conversion |
| Derive "today" from `node calendar.js now` | Use JavaScript `new Date()` for Pacific date | `new Date()` returns UTC; wrong after 4-5pm Pacific depending on DST |

Add a "Common Mistakes" subsection with 3 before/after examples:
1. WRONG: Agent uses `date +%Y-%m-%d` to get today, gets Feb 10 when it's still Feb 9 in Pacific. RIGHT: Agent runs `node calendar.js now`, gets correct Pacific date.
2. WRONG: Agent runs `node calendar.js list 10` when user says "what's today", returns events from multiple days. RIGHT: Agent runs `node calendar.js today`.
3. WRONG: Agent creates event with `2026-02-15T10:30:00Z`, event shows up at 2:30 AM Pacific. RIGHT: Agent creates event with `2026-02-15T10:30:00` (no Z), shows up at 10:30 AM Pacific.

**Calendar CLI section** -- Add a DO/DO NOT table for command selection:
| User says | DO use | DO NOT use | WHY |
| "what's today" / "schedule" | `today` | `list` | `list` doesn't respect Pacific day boundaries |
| "what's this week" | `week` | `upcoming 7` | `week` gives Mon-Sun Pacific; `upcoming 7` starts from now |
| "what's coming up" / "next few days" | `upcoming [N]` | `list [N]` | `upcoming` uses Pacific day boundaries |
| "show me my calendar" / "what's next" | `list` | `today` | `list` is forward-looking from now, good for "what's next" |

**Household Markdown Files section** -- Add a DO/DO NOT table:
| DO | DO NOT | WHY |
| Read the entire file before modifying | Append blindly without reading | Could duplicate items or corrupt format |
| Use `- [ ] item` for new todo items | Use `- item` or `* item` for todos | Checkbox format required for done/not-done tracking |
| Add Pacific timestamp to notes: `- [2026-02-09 10:30 PM PT] note text` | Add UTC timestamp or no timestamp | User is Pacific; timestamps without TZ are ambiguous |
| Write the complete file back after changes | Use `echo >>` to append | Risk of partial writes or encoding issues |
| Preserve existing formatting and headers | Rewrite the entire file structure | Other sections/headers are important context |

**Behavior section** -- Add a DO/DO NOT table:
| DO | DO NOT |
| Confirm actions briefly: "Added milk to shopping list" | Give long explanations of what you did |
| Use emojis naturally in responses | Skip emojis entirely (too robotic) or overuse them |
| Show times in Pacific with AM/PM | Show 24-hour time or UTC |
  </action>
  <verify>
    Grep TOOLS.md for "DO NOT" -- should appear in at least 4 distinct table sections.
    Grep TOOLS.md for "WRONG:" -- should appear at least 3 times in before/after examples.
    Grep TOOLS.md for "Common Mistakes" -- should appear at least once.
  </verify>
  <done>
    Every command section in TOOLS.md has a DO/DO NOT table. At least 3 before/after examples show common cheap-LLM mistakes with timezone and command selection. A reader can scan any section and immediately see what to avoid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand Telegram command handlers with exact parsing examples and edge cases</name>
  <files>TOOLS.md</files>
  <action>
Expand the Telegram Command Handlers section of TOOLS.md. Currently it lists trigger phrases and actions but does NOT show:
- Exact input -> parsed output examples
- How to handle ambiguous or multi-item input
- Edge cases (misspellings, compound requests, missing info)

For EACH handler subsection (Calendar, Todos, Shopping, Notes, Briefing), add:

**1. Parsing examples** showing exact user input and exact agent action:

Calendar:
```
Input: "what's today"
Action: node calendar.js today
Response format: List events with time, title. If none: "Nothing on the calendar today!"

Input: "add event dentist tomorrow at 2pm"
Parse: event="dentist", date=tomorrow's date, time=14:00
Action: node calendar.js add "dentist" "YYYY-MM-DDT14:00:00" "YYYY-MM-DDT15:00:00"
Note: Default duration 1 hour if no end time given. Get tomorrow's date from `node calendar.js now`, NOT from `date`.

Input: "add event dinner with mom friday 6-8pm"
Parse: event="dinner with mom", date=next Friday, start=18:00, end=20:00
Action: node calendar.js add "dinner with mom" "YYYY-MM-DDT18:00:00" "YYYY-MM-DDT20:00:00"
```

Todos:
```
Input: "add fix the fence"
Action: Read household/todos.md, append "- [ ] Fix the fence", write file back
Response: "Added! ‚úÖ Fix the fence"

Input: "done fix the fence"
Action: Read household/todos.md, find line matching "fix the fence" (case-insensitive), change "- [ ]" to "- [x]", write file back
Response: "Done! ‚úÖ Fix the fence"
Edge case: If no match found, respond "I couldn't find that task. Here's what's on the list: ..."

Input: "show todos"
Action: Read household/todos.md, format incomplete items for Telegram (no markdown tables)
Response: List items with checkboxes rendered as emoji (unchecked: ‚óªÔ∏è, checked: ‚úÖ)
```

Shopping:
```
Input: "add milk to shopping"
Action: Read household/shopping.md, append "- Milk", write file back
Response: "Added milk to the shopping list! üõí"

Input: "we need eggs, bread, and butter"
Action: Read household/shopping.md, append three separate lines: "- Eggs", "- Bread", "- Butter"
Response: "Added 3 items to shopping! üõí Eggs, Bread, Butter"
Edge case: Parse comma-separated AND "and"-separated lists into individual items.

Input: "bought milk"
Action: Read household/shopping.md, find line matching "milk" (case-insensitive), remove that line, write file back
Response: "Crossed off milk! üõí"
Edge case: If "milk" appears in multiple lines (e.g., "Milk" and "Almond milk"), ask which one.
```

Notes:
```
Input: "note: plumber's number is 555-1234"
Action: Read household/notes.md, append "- [2026-02-09 10:30 PM PT] Plumber's number is 555-1234", write file back
Note: Get current Pacific time from `node calendar.js now` for the timestamp. Format: YYYY-MM-DD h:mm AM/PM PT

Input: "remember that the wifi password is fish1234"
Action: Same as "note:" -- treat "remember" as a note trigger
```

**2. Edge cases section** at the end of Telegram handlers:

```
## Edge Cases

**Ambiguous commands:**
- "add eggs" -- Is this a todo or shopping item? Default to TODO. If user says "add eggs to shopping" or "we need eggs", then shopping.
- "milk" (just a word) -- Don't assume intent. Ask: "Did you want to add milk to the shopping list?"

**Multi-step requests:**
- "add dentist appointment tomorrow at 2pm and remind me to call insurance" -- Handle as TWO actions: calendar add + todo add. Confirm both.

**Missing information:**
- "add event tomorrow" -- Missing event name. Ask: "What's the event called?"
- "add event dentist" -- Missing date/time. Ask: "When is the dentist appointment?"

**Time parsing:**
- "2pm" = 14:00, "2:30" = 14:30 (assume PM for 1-6, AM for 7-12 if ambiguous)
- "tomorrow" = get today from `node calendar.js now`, add 1 day
- "friday" = next upcoming Friday (if today is Friday, means NEXT Friday)
- "this friday" = this week's Friday (could be today if today is Friday)
```
  </action>
  <verify>
    Grep TOOLS.md for "Input:" -- should appear at least 8 times (parsing examples).
    Grep TOOLS.md for "Edge case" or "Edge Cases" -- should appear at least 4 times.
    Grep TOOLS.md for "Parse:" -- should appear at least 2 times showing input decomposition.
  </verify>
  <done>
    Every Telegram command handler has at least 2 exact input/output parsing examples. Edge cases section covers ambiguous commands, multi-item parsing, missing information, and time parsing. A cheap LLM reading this section can handle "add eggs, bread, and butter to shopping" correctly without guessing.
  </done>
</task>

</tasks>

<verification>
1. TOOLS.md has DO/DO NOT tables in at least 4 sections (timezone, calendar CLI, household files, behavior)
2. At least 3 before/after "Common Mistakes" examples exist
3. Every Telegram command handler has exact parsing examples
4. Edge cases section exists covering ambiguous input, multi-item, missing info, time parsing
5. No information was removed from the original TOOLS.md -- only additions
</verification>

<success_criteria>
A cheap LLM (e.g., Haiku, GPT-3.5) reading the updated TOOLS.md would:
- Never use `date` shell command for current time
- Never use `list` when user says "today"
- Never add `Z` suffix to event times
- Correctly parse "add eggs, bread, and butter to shopping" as 3 items
- Know to ask for clarification when input is ambiguous
- Add Pacific timestamps to notes
</success_criteria>

<output>
After completion, create `.planning/phases/01-instruction-hardening/01-01-SUMMARY.md`
</output>
