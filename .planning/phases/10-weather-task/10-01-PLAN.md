---
phase: 10-weather-task
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tasks/weather/helpers/get-weather.js
  - tasks/weather/config.js
  - tasks/index.js
autonomous: true
user_setup:
  - service: openweathermap
    why: "Weather data API"
    env_vars:
      - name: OPENWEATHER_API_KEY
        source: "https://home.openweathermap.org/api_keys — sign up (free tier), copy API key"
    dashboard_config: []

must_haves:
  truths:
    - "Agent can request weather and receive structured WeatherData with temperature, conditions, forecast, and timestamp"
    - "Weather config fills default location and units when parameters are missing from request"
    - "Cache keys ignore request tone variations so 'weather today' and 'how is the weather' share cached data"
    - "Weather responses include temperature, conditions, forecast array, and timestamp"
  artifacts:
    - path: "tasks/weather/helpers/get-weather.js"
      provides: "OpenWeatherMap API call returning structured WeatherData"
      exports: ["getWeather"]
    - path: "tasks/weather/config.js"
      provides: "Weather task config with defaults, cache keyStrategy, single get intent"
      contains: "module.exports"
    - path: "tasks/index.js"
      provides: "Weather registered in task registry"
      contains: "weather: require('./weather/config')"
  key_links:
    - from: "tasks/weather/config.js"
      to: "tasks/weather/helpers/get-weather.js"
      via: "helpers map references getWeather function"
      pattern: "require.*helpers/get-weather"
    - from: "tasks/index.js"
      to: "tasks/weather/config.js"
      via: "registry entry"
      pattern: "weather.*require.*weather/config"
    - from: "tasks/weather/helpers/get-weather.js"
      to: "OpenWeatherMap API"
      via: "HTTPS GET request with API key"
      pattern: "api\\.openweathermap\\.org"
    - from: "tasks/weather/config.js"
      to: "tasks/cache.js"
      via: "cache config with custom keyStrategy"
      pattern: "keyStrategy"
---

<objective>
Create the weather task module with OpenWeatherMap API integration, default parameter filling, and tone-agnostic cache keys.

Purpose: Final task in the v2.0 task architecture. Enables the agent to request weather data and receive structured LLMPayload responses, following the same patterns as echo and calendar tasks.
Output: Working weather task registered in the task system, callable via `node tasks/index.js "weather get"` or programmatically via `runTask({task: 'weather', intent: 'get', parameters: {location: 'Seattle'}})`.
</objective>

<execution_context>
@/Users/greg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/greg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tasks/index.js
@tasks/orchestrator.js
@tasks/types.js
@tasks/cache.js
@tasks/calendar/config.js
@tasks/calendar/helpers/fetch-calendar.js
@tasks/echo/config.js
@tasks/echo/helpers/echo.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create get-weather helper and weather config</name>
  <files>tasks/weather/helpers/get-weather.js, tasks/weather/config.js</files>
  <action>
Create `tasks/weather/helpers/get-weather.js`:

1. Export an async `getWeather(parameters, context)` function following the exact helper signature pattern from echo.js and fetch-calendar.js.

2. The helper fills defaults when parameters are missing (WTHR-02):
   - `location`: default to `'Seattle,WA,US'` (Greg's location) if `parameters.location` is falsy
   - `units`: default to `'imperial'` if `parameters.units` is falsy
   Store defaults as constants at top of file: `const DEFAULT_LOCATION = 'Seattle,WA,US'` and `const DEFAULT_UNITS = 'imperial'`.

3. Read API key from `process.env.OPENWEATHER_API_KEY`. If missing, throw an Error: `'OPENWEATHER_API_KEY environment variable is required'`.

4. Call OpenWeatherMap current weather API using Node.js built-in `https` module (no new npm dependencies per project constraints):
   - Endpoint: `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&units=${units}&appid=${apiKey}`
   - Parse JSON response
   - On non-200 or API error (response.cod !== 200), throw Error with the API message

5. Also call the 5-day/3-hour forecast endpoint to get forecast data:
   - Endpoint: `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(location)}&units=${units}&cnt=8&appid=${apiKey}`
   - `cnt=8` gives ~24 hours of forecast in 3-hour intervals
   - Parse JSON response

6. Create a small `httpsGet(url)` helper function (private, not exported) that wraps `https.get` in a Promise, collects response data chunks, and resolves with parsed JSON. Handle errors by rejecting the promise.

7. Return structured WeatherData object:
   ```javascript
   {
     location: data.name,              // city name from API response
     temperature: {
       current: data.main.temp,
       feelsLike: data.main.feels_like,
       min: data.main.temp_min,
       max: data.main.temp_max
     },
     conditions: data.weather[0].description,  // e.g. "scattered clouds"
     humidity: data.main.humidity,
     wind: {
       speed: data.wind.speed,
       units: units === 'imperial' ? 'mph' : 'm/s'
     },
     forecast: forecastData.list.map(item => ({
       time: item.dt_txt,
       temp: item.main.temp,
       conditions: item.weather[0].description
     })),
     units: units,
     timestamp: new Date().toISOString()
   }
   ```

Create `tasks/weather/config.js`:

1. Follow the exact config pattern from calendar/config.js and echo/config.js.

2. Single intent `'get'` with helpers: `['getWeather']`.

3. No validation needed (all parameters have defaults).

4. Cache config with TTL-based expiry (WTHR-03):
   - `ttl: 1800000` (30 minutes - weather data doesn't change every minute)
   - Custom `keyStrategy` that ignores tone/query and keys ONLY on location + units:
     ```javascript
     keyStrategy: (task, intent, params) => {
       const location = (params.location || 'Seattle,WA,US').toLowerCase();
       const units = params.units || 'imperial';
       return `${task}:${intent}:${location}:${units}`;
     }
     ```
   This ensures "weather today", "how's the weather", and "what's the weather like" all produce the same cache key `weather:get:seattle,wa,us:imperial`, satisfying WTHR-03.

5. Export the config object with: task, intents, helpers, cache.
  </action>
  <verify>
Verify file structure exists:
- `ls tasks/weather/helpers/get-weather.js tasks/weather/config.js`
- `node -e "const c = require('./tasks/weather/config'); console.log(c.task, Object.keys(c.intents), Object.keys(c.helpers));"` outputs `weather ['get'] ['getWeather']`
- `node -e "const c = require('./tasks/weather/config'); const k = c.cache.keyStrategy; console.log(k('weather','get',{})); console.log(k('weather','get',{query:'how is the weather'})); console.log(k('weather','get',{location:'Portland,OR'}));"` — first two keys are identical (tone ignored), third differs by location.
  </verify>
  <done>
- get-weather.js exports async getWeather function that calls OpenWeatherMap API and returns structured WeatherData
- Default location (Seattle,WA,US) and units (imperial) are filled when parameters missing
- config.js follows established TaskConfig pattern with get intent, helper map, and TTL cache
- Cache keyStrategy produces identical keys for different phrasings of the same weather request
  </done>
</task>

<task type="auto">
  <name>Task 2: Register weather task and verify end-to-end</name>
  <files>tasks/index.js</files>
  <action>
Add weather to the task registry in `tasks/index.js`:

1. Add require at the registry object (line ~20, after calendar entry):
   ```javascript
   weather: require('./weather/config'),
   ```

2. Verify the full pipeline works end-to-end by running:
   - `node -e "const c = require('./tasks/weather/config'); console.log(JSON.stringify(c, null, 2))"` — config loads without errors
   - `node -e "const {runTask} = require('./tasks/index'); runTask({task:'weather',intent:'get',parameters:{}}).then(r => console.log(JSON.stringify(r,null,2)))"` — if OPENWEATHER_API_KEY is set, returns LLMPayload with weather data; if not set, returns error payload with the env var message
   - Verify cache behavior: run the same request twice and confirm second response has `meta.cached: true` (only works with valid API key)

3. Do NOT add any npm dependencies. The implementation uses only Node.js built-in `https` module.
  </action>
  <verify>
- `node -e "const {runTask} = require('./tasks/index'); console.log('loaded');"` — loads without errors
- `node -e "const r = require('./tasks/index'); r.runTask('weather get').then(p => console.log(p.task, p.intent, p.meta.error || 'ok'))"` — outputs `weather get` followed by either `ok` (with API key) or the env var error message (without API key). Both are valid — error payload means the pipeline works correctly.
- `node -e "const r = require('./tasks/index'); r.runTask({task:'weather',intent:'bogus',parameters:{}}).then(p => console.log(p.meta.error))"` — outputs `Unknown intent: bogus for task: weather`
  </verify>
  <done>
- Weather task registered in tasks/index.js registry
- `runTask('weather get')` returns structured LLMPayload (with data if API key present, with error payload if not)
- Unknown intents return proper error payloads
- No new npm dependencies added
  </done>
</task>

</tasks>

<verification>
Phase 10 requirements verification:

1. **WTHR-01** (get-weather helper returns structured WeatherData):
   - `node -e "const {getWeather} = require('./tasks/weather/helpers/get-weather'); getWeather({},{}).then(d => console.log(Object.keys(d)))"`
   - Expected keys: location, temperature, conditions, humidity, wind, forecast, units, timestamp

2. **WTHR-02** (config fills defaults):
   - `node -e "const {getWeather} = require('./tasks/weather/helpers/get-weather'); getWeather({},{}).then(d => console.log(d.location, d.units))"`
   - Should output default location name and 'imperial'

3. **WTHR-03** (cache keys ignore tone):
   - `node -e "const c = require('./tasks/weather/config'); const k = c.cache.keyStrategy; console.log(k('w','get',{query:'weather today'}) === k('w','get',{query:'hows the weather'}))"`
   - Should output `true`

4. **Success Criteria from Roadmap:**
   - Weather responses include temperature, conditions, forecast, and timestamp (check WeatherData structure)
   - Cache ignores request tone variations (keyStrategy verified above)
   - Weather config fills default location and units (verified above)
</verification>

<success_criteria>
- All 3 weather task files exist and load without errors
- Weather task is registered in the task system registry
- getWeather helper returns structured object with temperature, conditions, forecast, humidity, wind, units, timestamp
- Default location and units are filled when not provided in parameters
- Cache keyStrategy produces identical keys regardless of query/tone differences
- No new npm dependencies added (uses built-in https module)
- Pipeline returns proper error payload when API key is missing
</success_criteria>

<output>
After completion, create `.planning/phases/10-weather-task/10-01-SUMMARY.md`
</output>
