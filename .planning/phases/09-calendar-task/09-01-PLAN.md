---
phase: 09-calendar-task
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - calendar/calendar.js
  - tasks/calendar/helpers/fetch-calendar.js
  - tasks/calendar/config.js
  - tasks/index.js
autonomous: true

must_haves:
  truths:
    - "calendar.js functions are importable via require() from other modules"
    - "calendar.js CLI mode still works identically (node calendar/calendar.js today)"
    - "Agent can request calendar events for a date range and receive structured event list"
    - "Calendar task is registered and runnable via runTask('calendar get today')"
  artifacts:
    - path: "calendar/calendar.js"
      provides: "Exported calendar functions"
      contains: "module.exports"
    - path: "tasks/calendar/helpers/fetch-calendar.js"
      provides: "Structured event fetching helper"
      exports: ["fetchCalendar"]
    - path: "tasks/calendar/config.js"
      provides: "Calendar task configuration with get intent"
      exports: ["task", "intents", "helpers", "cache"]
    - path: "tasks/index.js"
      provides: "Calendar registered in task registry"
      contains: "calendar"
  key_links:
    - from: "tasks/calendar/helpers/fetch-calendar.js"
      to: "calendar/calendar.js"
      via: "require('../../calendar/calendar')"
      pattern: "require.*calendar"
    - from: "tasks/calendar/config.js"
      to: "tasks/calendar/helpers/fetch-calendar.js"
      via: "require('./helpers/fetch-calendar')"
      pattern: "require.*fetch-calendar"
    - from: "tasks/index.js"
      to: "tasks/calendar/config.js"
      via: "registry entry"
      pattern: "calendar.*require.*calendar/config"
---

<objective>
Export calendar.js functions for programmatic use and create the fetch-calendar helper that returns structured event data through the task orchestrator.

Purpose: This is the foundation for all calendar task operations. calendar.js must be importable (not just CLI), and the "get" intent must return structured LLMPayload responses instead of console.log text.

Output: Working `calendar get today` / `calendar get week` / `calendar get upcoming 7` via runTask()
</objective>

<execution_context>
@/Users/greg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/greg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-task-infrastructure/07-02-SUMMARY.md
@.planning/phases/08-cache-layer/08-02-SUMMARY.md
@calendar/calendar.js
@tasks/echo/config.js
@tasks/echo/helpers/echo.js
@tasks/orchestrator.js
@tasks/index.js
@tasks/types.js
@tasks/cache.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export calendar.js functions while preserving CLI mode</name>
  <files>calendar/calendar.js</files>
  <action>
Add module.exports at the bottom of calendar/calendar.js, ABOVE the CLI block. Export these functions:
- loadConfig, getAuthClient
- nowInPacific, formatPacific, formatPacificDate, pacificMidnightToUTC
- todayBounds, thisWeekBounds, nextNDaysBounds
- listEvents, createEvent, deleteEvent, updateEvent

Wrap the entire CLI block (lines 300-414, from `const command = process.argv[2]` through the end of the async IIFE) inside an `if (require.main === module)` guard so CLI mode only runs when executed directly.

Structure:
```
module.exports = {
  loadConfig, getAuthClient,
  nowInPacific, formatPacific, formatPacificDate, pacificMidnightToUTC,
  todayBounds, thisWeekBounds, nextNDaysBounds,
  listEvents, createEvent, deleteEvent, updateEvent
};

// CLI mode - only runs when executed directly
if (require.main === module) {
  const command = process.argv[2];
  // ... existing CLI code unchanged ...
}
```

Do NOT change any function implementations. Only add exports and the require.main guard.
  </action>
  <verify>
1. `node -e "const cal = require('./calendar/calendar'); console.log(Object.keys(cal).sort().join(', '))"` prints all exported function names
2. `node calendar/calendar.js now` still prints current Pacific time (CLI preserved)
3. `node -e "const cal = require('./calendar/calendar'); console.log(typeof cal.listEvents)"` prints "function"
  </verify>
  <done>calendar.js exports all core functions AND CLI mode works identically to before</done>
</task>

<task type="auto">
  <name>Task 2: Create fetch-calendar helper</name>
  <files>tasks/calendar/helpers/fetch-calendar.js</files>
  <action>
Create `tasks/calendar/helpers/fetch-calendar.js` following the echo helper pattern.

The helper imports calendar functions via require():
```
const { loadConfig, listEvents, todayBounds, thisWeekBounds, nextNDaysBounds } = require('../../../calendar/calendar');
```

Export a single async function `fetchCalendar(parameters, context)` that:

1. Calls `loadConfig()` to get calendarId
2. Reads `parameters.range` (default: 'today'). Supported ranges: 'today', 'week', 'upcoming', 'list'
3. Builds options based on range:
   - 'today': uses todayBounds(), maxResults 50
   - 'week': uses thisWeekBounds(), maxResults 50
   - 'upcoming': uses nextNDaysBounds(parameters.days || 7), maxResults 50
   - 'list': uses {maxResults: parameters.maxResults || 10}
4. Calls `listEvents(calendarId, options)` (it's async, await it)
5. Maps the raw Google Calendar events array to structured objects:
   ```
   {
     id: event.id,
     summary: event.summary || '(no title)',
     start: event.start.dateTime || event.start.date,
     end: event.end.dateTime || event.end.date,
     allDay: !!event.start.date,
     description: event.description || null,
     location: event.location || null
   }
   ```
6. Returns: `{ events: mappedEvents, count: mappedEvents.length, range: parameters.range || 'today' }`

Note: listEvents() currently does console.log inside it. That's acceptable for now -- the structured return from this helper is what the LLMPayload wraps. The console.log output is harmless when called programmatically (it goes to stdout which the agent doesn't see).
  </action>
  <verify>
1. `node -e "const h = require('./tasks/calendar/helpers/fetch-calendar'); console.log(typeof h.fetchCalendar)"` prints "function"
2. File exists at tasks/calendar/helpers/fetch-calendar.js
  </verify>
  <done>fetchCalendar helper exists, imports calendar.js directly, and returns structured event data</done>
</task>

<task type="auto">
  <name>Task 3: Create calendar config and register in task index</name>
  <files>tasks/calendar/config.js, tasks/index.js</files>
  <action>
**tasks/calendar/config.js** - Follow the echo/config.js pattern exactly:

```js
const { fetchCalendar } = require('./helpers/fetch-calendar');

module.exports = {
  task: 'calendar',
  intents: {
    'get': {
      helpers: ['fetchCalendar']
    }
  },
  helpers: {
    'fetchCalendar': fetchCalendar
  },
  cache: {
    dailyReset: true,
    keyStrategy: (task, intent, params) => {
      const range = params.range || params.query || 'today';
      const days = params.days || '';
      return `${task}:${intent}:${range}${days ? ':' + days : ''}`;
    }
  }
};
```

Cache uses dailyReset (calendar events for "today" change each day) with a keyStrategy that differentiates by range (so "today" and "week" have separate cache entries). No TTL needed since dailyReset handles expiry.

**tasks/index.js** - Add one line to the registry:

```js
const registry = {
  echo: require('./echo/config'),
  calendar: require('./calendar/config'),
};
```

No other changes to index.js.
  </action>
  <verify>
1. `node tasks/index.js "calendar get"` returns valid LLMPayload JSON with task: 'calendar', intent: 'get', and data.events array (requires valid Google Calendar credentials)
2. `node -e "const c = require('./tasks/calendar/config'); console.log(c.task, Object.keys(c.intents).join(','))"` prints "calendar get"
3. `node -e "const idx = require('./tasks/index'); console.log('loaded')"` prints "loaded" without errors (registry loads cleanly)
  </verify>
  <done>Calendar task registered in index.js, config routes "get" intent to fetchCalendar helper, cache uses dailyReset with range-aware key strategy</done>
</task>

</tasks>

<verification>
1. `node calendar/calendar.js today` still works (CLI backward compatibility)
2. `node -e "const cal = require('./calendar/calendar'); console.log(typeof cal.listEvents)"` prints "function"
3. `node tasks/index.js "calendar get"` returns LLMPayload with structured event data
4. `node -e "const c = require('./tasks/calendar/config'); console.log(JSON.stringify({task: c.task, intents: Object.keys(c.intents), hasCache: !!c.cache}))"` shows task, intents, and cache config
5. Registry loads without errors: `node -e "require('./tasks/index'); console.log('ok')"`
</verification>

<success_criteria>
- calendar.js exports all functions AND CLI mode is preserved
- fetchCalendar helper returns structured {events, count, range} data
- Calendar config routes "get" intent to fetchCalendar
- Cache configured with dailyReset and range-aware keyStrategy
- Calendar registered in tasks/index.js
- `runTask("calendar get")` returns valid LLMPayload
</success_criteria>

<output>
After completion, create `.planning/phases/09-calendar-task/09-01-SUMMARY.md`
</output>
