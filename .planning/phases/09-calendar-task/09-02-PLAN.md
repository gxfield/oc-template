---
phase: 09-calendar-task
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - tasks/calendar/helpers/set-calendar-item.js
  - tasks/calendar/helpers/remove-calendar-item.js
  - tasks/calendar/config.js
autonomous: true

must_haves:
  truths:
    - "Agent can create calendar events and receive confirmation with event details"
    - "Agent can delete calendar events and receive confirmation with updated event list"
    - "Calendar config routes add intent to set-calendar-item helper"
    - "Calendar config routes remove intent to remove-calendar-item then fetch-calendar chain"
  artifacts:
    - path: "tasks/calendar/helpers/set-calendar-item.js"
      provides: "Event creation helper"
      exports: ["setCalendarItem"]
    - path: "tasks/calendar/helpers/remove-calendar-item.js"
      provides: "Event deletion helper"
      exports: ["removeCalendarItem"]
    - path: "tasks/calendar/config.js"
      provides: "Complete calendar config with get/add/remove intents"
      contains: "add"
  key_links:
    - from: "tasks/calendar/helpers/set-calendar-item.js"
      to: "calendar/calendar.js"
      via: "require('../../calendar/calendar')"
      pattern: "require.*calendar.*createEvent"
    - from: "tasks/calendar/helpers/remove-calendar-item.js"
      to: "calendar/calendar.js"
      via: "require('../../calendar/calendar')"
      pattern: "require.*calendar.*deleteEvent"
    - from: "tasks/calendar/config.js"
      to: "tasks/calendar/helpers/set-calendar-item.js"
      via: "require and intent routing"
      pattern: "setCalendarItem"
    - from: "tasks/calendar/config.js"
      to: "tasks/calendar/helpers/remove-calendar-item.js"
      via: "require and intent routing"
      pattern: "removeCalendarItem"
---

<objective>
Add event creation and deletion helpers to the calendar task, completing all CRUD operations through the task orchestrator.

Purpose: Agents need to create and delete calendar events programmatically and receive structured confirmation responses instead of CLI text. The "remove" intent chains deletion with a fresh event fetch so the agent sees the updated state.

Output: Working `calendar add` and `calendar remove` intents via runTask()
</objective>

<execution_context>
@/Users/greg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/greg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-calendar-task/09-01-SUMMARY.md
@calendar/calendar.js
@tasks/calendar/config.js
@tasks/calendar/helpers/fetch-calendar.js
@tasks/orchestrator.js
@tasks/types.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create set-calendar-item helper</name>
  <files>tasks/calendar/helpers/set-calendar-item.js</files>
  <action>
Create `tasks/calendar/helpers/set-calendar-item.js`.

Import from calendar.js:
```
const { loadConfig, createEvent } = require('../../../calendar/calendar');
```

Export async function `setCalendarItem(parameters, context)` that:

1. Calls `loadConfig()` to get calendarId and timeZone (default 'America/Los_Angeles')
2. Reads parameters: summary (required), start, end, description, location, allDay, date
3. Builds eventData based on whether it's an all-day or timed event:

   **All-day event** (parameters.allDay === true or parameters.date is present):
   ```
   { summary, description: description || '', start: { date: parameters.date }, end: { date: parameters.date } }
   ```

   **Timed event** (start and end present):
   ```
   { summary, description: description || '', start: { dateTime: start, timeZone: tz }, end: { dateTime: end, timeZone: tz } }
   ```
   If location is provided, add it to eventData.

4. Calls `await createEvent(calendarId, eventData)`
5. Maps the returned Google Calendar event to a structured object:
   ```
   {
     created: true,
     event: {
       id: result.id,
       summary: result.summary,
       start: result.start.dateTime || result.start.date,
       end: result.end.dateTime || result.end.date,
       allDay: !!result.start.date,
       htmlLink: result.htmlLink || null
     }
   }
   ```
6. Returns the structured object

Note: createEvent() in calendar.js does console.log internally -- that's acceptable (same as fetch-calendar approach).
  </action>
  <verify>
1. `node -e "const h = require('./tasks/calendar/helpers/set-calendar-item'); console.log(typeof h.setCalendarItem)"` prints "function"
2. File exists at tasks/calendar/helpers/set-calendar-item.js
  </verify>
  <done>setCalendarItem helper exists, imports createEvent from calendar.js, returns structured {created, event} data</done>
</task>

<task type="auto">
  <name>Task 2: Create remove-calendar-item helper</name>
  <files>tasks/calendar/helpers/remove-calendar-item.js</files>
  <action>
Create `tasks/calendar/helpers/remove-calendar-item.js`.

Import from calendar.js:
```
const { loadConfig, deleteEvent } = require('../../../calendar/calendar');
```

Export async function `removeCalendarItem(parameters, context)` that:

1. Calls `loadConfig()` to get calendarId
2. Reads `parameters.eventId` (required -- the Google Calendar event ID to delete)
3. Calls `await deleteEvent(calendarId, parameters.eventId)`
4. Returns: `{ deleted: true, eventId: parameters.eventId }`

This helper does NOT fetch the updated event list. The "remove" intent in config.js chains this helper with fetchCalendar, so the orchestrator will call fetchCalendar next with the previousResult containing the deletion confirmation. The fetchCalendar helper runs independently (it doesn't use previousResult), so chaining works naturally -- the final result will be the fresh event list from fetchCalendar, and the deletion confirmation flows through context.previousResult if needed.

IMPORTANT: Since the orchestrator returns the LAST helper's result as the LLMPayload data, the "remove" chain (removeCalendarItem -> fetchCalendar) will return the event list as data. This is the desired behavior -- after deleting, the agent sees the updated calendar.
  </action>
  <verify>
1. `node -e "const h = require('./tasks/calendar/helpers/remove-calendar-item'); console.log(typeof h.removeCalendarItem)"` prints "function"
2. File exists at tasks/calendar/helpers/remove-calendar-item.js
  </verify>
  <done>removeCalendarItem helper exists, imports deleteEvent from calendar.js, returns structured {deleted, eventId} data</done>
</task>

<task type="auto">
  <name>Task 3: Update config with add and remove intents and validators</name>
  <files>tasks/calendar/config.js</files>
  <action>
Update `tasks/calendar/config.js` to add the "add" and "remove" intents.

Import the new helpers:
```
const { fetchCalendar } = require('./helpers/fetch-calendar');
const { setCalendarItem } = require('./helpers/set-calendar-item');
const { removeCalendarItem } = require('./helpers/remove-calendar-item');
```

Updated config:
```js
module.exports = {
  task: 'calendar',
  intents: {
    'get': {
      helpers: ['fetchCalendar']
    },
    'add': {
      helpers: ['setCalendarItem'],
      validate: (params) => {
        if (!params.summary) return 'summary is required to create an event';
        const isAllDay = params.allDay || params.date;
        if (!isAllDay && (!params.start || !params.end)) {
          return 'start and end are required for timed events (or use allDay/date for all-day events)';
        }
        return null;
      }
    },
    'remove': {
      helpers: ['removeCalendarItem', 'fetchCalendar'],
      validate: (params) => {
        if (!params.eventId) return 'eventId is required to delete an event';
        return null;
      }
    }
  },
  helpers: {
    'fetchCalendar': fetchCalendar,
    'setCalendarItem': setCalendarItem,
    'removeCalendarItem': removeCalendarItem
  },
  cache: {
    dailyReset: true,
    keyStrategy: (task, intent, params) => {
      const range = params.range || params.query || 'today';
      const days = params.days || '';
      return `${task}:${intent}:${range}${days ? ':' + days : ''}`;
    }
  }
};
```

Key design decisions:
- "add" intent: single helper (setCalendarItem). No caching for mutations.
- "remove" intent: chains removeCalendarItem -> fetchCalendar. The orchestrator runs helpers sequentially, so deletion happens first, then a fresh event list is fetched. The LLMPayload data will be the fetchCalendar result (updated event list).
- Cache only applies to "get" intent because the keyStrategy produces different keys per intent (cache:add:... and cache:remove:... won't match get entries). Mutations will create cache entries but they won't interfere with get entries due to different keys. This is acceptable behavior -- the mutation cache entries will expire on daily reset.
- Validators ensure required fields are present before hitting Google API.
  </action>
  <verify>
1. `node -e "const c = require('./tasks/calendar/config'); console.log(c.task, Object.keys(c.intents).sort().join(','))"` prints "calendar add,get,remove"
2. `node -e "const c = require('./tasks/calendar/config'); console.log(c.intents.add.validate({}))"` prints error about summary
3. `node -e "const c = require('./tasks/calendar/config'); console.log(c.intents.add.validate({summary: 'Test', start: 'x', end: 'y'}))"` prints null
4. `node -e "const c = require('./tasks/calendar/config'); console.log(c.intents.remove.validate({}))"` prints error about eventId
5. `node -e "const c = require('./tasks/calendar/config'); console.log(c.intents.remove.helpers.join(' -> '))"` prints "removeCalendarItem -> fetchCalendar"
  </verify>
  <done>Calendar config has get/add/remove intents, validators for add and remove, helper chain for remove intent returns updated event list after deletion</done>
</task>

</tasks>

<verification>
1. `node -e "const c = require('./tasks/calendar/config'); console.log(c.task, Object.keys(c.intents).sort().join(','))"` shows all 3 intents
2. `node tasks/index.js "calendar get"` returns LLMPayload with event data (requires credentials)
3. Validators reject missing required fields: summary for add, eventId for remove
4. "remove" intent helper chain is [removeCalendarItem, fetchCalendar] for post-delete confirmation
5. All helpers import from calendar/calendar.js via require() (not shell exec)
</verification>

<success_criteria>
- setCalendarItem helper creates events via calendar.js createEvent() and returns structured data
- removeCalendarItem helper deletes events via calendar.js deleteEvent() and returns structured data
- Calendar config has 3 intents: get, add, remove
- "add" intent validates summary and start/end (or allDay/date)
- "remove" intent validates eventId and chains delete -> fetch for updated list
- No caching interference between get and mutation intents
- All calendar operations flow through task orchestrator with LLMPayload responses
</success_criteria>

<output>
After completion, create `.planning/phases/09-calendar-task/09-02-SUMMARY.md`
</output>
