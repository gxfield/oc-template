---
phase: 02-add-the-ability-for-the-bot-to-create-a-telegram-poll
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - TOOLS.md
  - QUICKSTART.md
  - AGENTS.md
  - HEARTBEAT.md
autonomous: true

must_haves:
  truths:
    - "Agent knows how to detect poll intent from natural language and invoke the poll task"
    - "Agent knows how to handle poll_answer updates by calling the vote intent"
    - "Agent checks for poll timeouts during heartbeat"
    - "QUICKSTART.md has a concise poll command reference"
  artifacts:
    - path: "TOOLS.md"
      provides: "Complete poll documentation with trigger phrases, parsing rules, examples, and DO/DO NOT tables"
      contains: "Telegram Poll"
    - path: "QUICKSTART.md"
      provides: "Condensed poll command reference"
      contains: "Poll"
    - path: "AGENTS.md"
      provides: "Poll mention in Step 4 feature awareness"
      contains: "Poll"
    - path: "HEARTBEAT.md"
      provides: "Poll timeout check instruction"
      contains: "poll"
  key_links:
    - from: "TOOLS.md"
      to: "tasks/index.js"
      via: "documents the CLI commands for poll task"
      pattern: 'node tasks/index.js "poll'
    - from: "HEARTBEAT.md"
      to: "tasks/index.js"
      via: "heartbeat runs poll check-timeout"
      pattern: 'poll check-timeout'
---

<objective>
Document the poll feature in agent instruction files so the bot can detect poll intent, invoke the task system, handle votes, and check timeouts.

Purpose: The agent (powered by cheap LLMs via OpenClaw) needs clear instructions to: (1) recognize natural language poll requests, (2) parse question and options, (3) call the right task commands, (4) handle poll_answer updates, and (5) check timeouts during heartbeat. Without these docs, the agent won't know the feature exists.

Output: Updated TOOLS.md, QUICKSTART.md, AGENTS.md, and HEARTBEAT.md with complete poll documentation.
</objective>

<execution_context>
@/Users/greg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/greg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-add-the-ability-for-the-bot-to-create-a-telegram-poll/02-01-SUMMARY.md
@.planning/phases/02-add-the-ability-for-the-bot-to-create-a-telegram-poll/02-02-SUMMARY.md

@TOOLS.md
@QUICKSTART.md
@AGENTS.md
@HEARTBEAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add poll section to TOOLS.md with full documentation</name>
  <files>TOOLS.md</files>
  <action>
Add a new `## ðŸ“Š Telegram Polls` section to TOOLS.md. Place it AFTER the `## ðŸ’¬ Telegram Command Handlers` section (before `## Edge Cases for Telegram Command Parsing`). Follow the exact documentation pattern of existing sections (trigger phrase table, parsing rules, input/output examples, DO/DO NOT table, edge cases).

**Section content:**

### Trigger Phrase Table

The agent uses natural language intent detection â€” there is NO /poll command. The user provides the question AND options in a single message.

| Trigger Pattern | Action |
|---|---|
| "let's vote on X: option1, option2" | Create poll with question X and given options |
| "poll: X? option1 or option2" | Create poll |
| "should we do X or Y" | Create poll with question "Should we do X or Y?" and options X, Y |
| "what should we have for dinner: tacos, pizza, or sushi" | Create poll |
| "vote: X or Y or Z" | Create poll |

### Parsing Rules for Poll Creation

1. Detect poll intent: message contains a question with 2-4 distinct options, often separated by "or", commas, or listed after a colon
2. Extract the question (the part before options) and the options (2-4 choices)
3. If the bot can't parse a clear question + options, ask for clarification: "I'd love to set up a poll! What's the question and what are the options?"
4. Call: `node tasks/index.js "poll create question=QUESTION options=OPTION1,OPTION2,OPTION3"`
5. Confirm to the user: "Poll created! ðŸ“Š Vote in the group chat."

### Handling Poll Answers (poll_answer updates)

When the platform delivers a `poll_answer` update (a user voted on a poll):
1. Extract the user ID and selected option index from the update
2. Call: `node tasks/index.js "poll vote userId=USER_ID optionId=OPTION_INDEX"`
3. The task system handles everything: recording the vote, detecting ties, tie-breaking, closing the poll, and sending announcements
4. If the result says `resolved: true` with `tie: true`, the bot already sent the announcement via Telegram API â€” no additional message needed from the agent
5. If the result says `resolved: true` with `silent: true` (both agreed), the poll is already closed â€” no message needed
6. If the result says `recorded: true` (still waiting), no action needed â€” just wait for the other vote

### Handling Poll Timeouts (heartbeat integration)

During heartbeat, run: `node tasks/index.js "poll check-timeout"`
- If result has `timedOut: true`: the bot already resolved and announced it. Log it in daily memory.
- If result has `hasActivePoll: false`: nothing to do.
- If result has `timedOut: false`: poll still active, no action needed.

### Input/Output Examples

**Example 1 â€” Create poll:**

**Input:** "what should we have for dinner tonight: tacos, pizza, or sushi?"
**Parse:** question="What should we have for dinner tonight?", options=["Tacos", "Pizza", "Sushi"]
**Action:** `node tasks/index.js "poll create question=What should we have for dinner tonight? options=Tacos,Pizza,Sushi"`
**Response:** "Poll's up! ðŸ“Š Vote away!"

**Example 2 â€” Simple either/or:**

**Input:** "should we do movie night or game night"
**Parse:** question="Movie night or game night?", options=["Movie night", "Game night"]
**Action:** `node tasks/index.js "poll create question=Movie night or game night? options=Movie night,Game night"`
**Response:** "Poll created! ðŸ“Š"

**Example 3 â€” Bot can't parse:**

**Input:** "let's vote on something"
**Response:** "I'd love to set up a poll! What's the question and what are the options? (Give me 2-4 choices)"

**Example 4 â€” Poll already active:**

**Input:** "let's vote: pizza or burgers"
**Action:** Task returns error about existing active poll
**Response:** "There's already a poll running! Let that one finish first, or I can close it for you."

### Downstream Actions

After a poll resolves (by votes or timeout), the winning option may trigger a follow-up action based on context:

| Poll Context | Downstream Action |
|---|---|
| Dinner/meal poll (question contains dinner, meal, eat, food, lunch) | Update tonight's entry in `household/meals/this-week.md` with the winning option |
| Other polls | No automatic action â€” just announce the result |

**Implementation:** After receiving a resolved poll result with a winner, check if the question is meal-related. If so, get today's day name from `node calendar/calendar.js now`, read `household/meals/this-week.md`, update the matching day line with the winner, write file back.

### DO / DO NOT for Polls

| DO | DO NOT | WHY |
|---|---|---|
| Detect poll intent from natural language | Require a /poll command | Per user decision: natural language, no commands |
| Send poll immediately when intent is clear | Ask for confirmation/preview before sending | Per user decision: no preview step |
| Let the task system handle tie-breaking and announcements | Try to handle tie-break logic in agent instructions | Task system has the logic; agent just calls intents |
| Check poll timeout during heartbeat | Skip timeout checks | Stale polls should auto-resolve |
| Update meal plan after dinner poll resolves | Update meal plan for non-food polls | Only meal-related polls trigger downstream meal updates |
| Ask for clarification if question + options unclear | Guess what the user meant | Bad polls waste everyone's time |

### Edge Cases

- **Only 1 option detected:** "let's vote on tacos" â€” Ask: "That's just one option! What else should I put on the poll?"
- **More than 4 options:** "A, B, C, D, E" â€” Ask: "I can do up to 4 options. Which ones should I include?"
- **Poll already active:** Return the existing poll question and suggest closing it first
- **User votes on a non-bot poll:** poll_answer update won't match any active poll â€” task returns "No active poll" error, agent ignores silently
- **Bot can't determine if message is a poll request:** When in doubt, don't create a poll. Only create when there's a clear question + multiple options.
  </action>
  <verify>
Read TOOLS.md and verify:
1. New `## ðŸ“Š Telegram Polls` section exists
2. Section contains: Trigger Phrase Table, Parsing Rules, Handling Poll Answers, Handling Poll Timeouts, Input/Output Examples, Downstream Actions, DO/DO NOT table, Edge Cases
3. Section is placed after Telegram Command Handlers and before Edge Cases for Telegram Command Parsing
4. All task commands use correct syntax: `node tasks/index.js "poll ..."` format
  </verify>
  <done>
TOOLS.md has a complete Telegram Polls section with trigger phrases, parsing rules for poll creation, poll_answer handling instructions, heartbeat timeout checking, input/output examples, downstream meal plan actions, DO/DO NOT table, and edge cases. Agent has everything needed to detect poll intent and interact with the poll task system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update QUICKSTART.md, AGENTS.md, and HEARTBEAT.md with poll references</name>
  <files>
    QUICKSTART.md
    AGENTS.md
    HEARTBEAT.md
  </files>
  <action>
**QUICKSTART.md:**

Add a `## Polls` section after the `## Save Recipe` section and before `## Response Style`. Keep it concise (the QUICKSTART pattern â€” minimal lines, just the essentials). Content:

```markdown
## Polls

Natural language poll creation â€” no /poll command needed.

| Task | Command |
|------|---------|
| Create poll | `node tasks/index.js "poll create question=Question? options=A,B,C"` |
| Record vote | `node tasks/index.js "poll vote userId=ID optionId=INDEX"` |
| Check timeout | `node tasks/index.js "poll check-timeout"` |
| Stop poll | `node tasks/index.js "poll stop"` |

- Detect intent: user gives question + 2-4 options in one message
- Send poll immediately, no preview
- Bot votes only on ties, using household context (avoids repeat meals)
- Auto-closes after both vote or on timeout
- Meal polls update tonight's dinner in this-week.md
```

**AGENTS.md:**

In Step 4 (Load tools reference), add a bullet point for polls following the same pattern as Quick Capture, Meal Planning, Briefing, and Save Recipe. Add after the Save Recipe bullet:

```markdown
- **Polls:** Users can create household polls by asking with options (e.g., "should we do tacos or pizza?"). Bot sends native Telegram poll, acts as tie-breaker. Handle poll_answer updates by calling vote intent. Check timeouts during heartbeat. See TOOLS.md Telegram Polls section.
```

**HEARTBEAT.md:**

Read the current HEARTBEAT.md content. Add a poll timeout check item to the heartbeat checklist. Add this line to the heartbeat tasks (if there's a checklist, add to it; if it's prose, add a bullet):

```markdown
- **Poll timeout:** Run `node tasks/index.js "poll check-timeout"`. If a poll has timed out, it auto-resolves and announces the result. Log the outcome in daily memory if a poll was resolved.
```
  </action>
  <verify>
1. QUICKSTART.md contains `## Polls` section with correct task commands
2. AGENTS.md Step 4 mentions Polls with trigger description and TOOLS.md reference
3. HEARTBEAT.md mentions poll timeout check with the correct command
4. QUICKSTART.md stays under ~130 lines total (original was 125 lines, adding ~12)
5. No existing content was removed or altered in any file â€” only additions
  </verify>
  <done>
All agent instruction files updated: QUICKSTART.md has concise poll command reference, AGENTS.md Step 4 includes poll feature awareness, HEARTBEAT.md includes poll timeout check. Agent running on any LLM now knows the poll feature exists and how to use it.
  </done>
</task>

</tasks>

<verification>
1. TOOLS.md has complete poll section with all subsections
2. QUICKSTART.md has poll command reference table
3. AGENTS.md Step 4 mentions polls
4. HEARTBEAT.md includes poll timeout check
5. All file additions follow existing patterns and formatting conventions
6. No existing content was modified â€” only new content added
</verification>

<success_criteria>
The agent instruction files fully document the poll feature. An LLM agent reading these files will know: (1) how to detect poll intent from natural language, (2) how to parse question + options, (3) which task commands to call for each scenario, (4) how to handle poll_answer updates, (5) how to check for timeouts during heartbeat, and (6) when to trigger downstream actions (meal plan updates). The documentation follows the existing DO/DO NOT table pattern for LLM reliability.
</success_criteria>

<output>
After completion, create `.planning/phases/02-add-the-ability-for-the-bot-to-create-a-telegram-poll/02-03-SUMMARY.md`
</output>
