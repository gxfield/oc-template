---
phase: 02-add-the-ability-for-the-bot-to-create-a-telegram-poll
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tasks/poll/helpers/telegram-api.js
  - tasks/poll/helpers/send-poll.js
  - tasks/poll/helpers/poll-state.js
  - tasks/poll/config.js
  - tasks/index.js
  - credentials.json.example
autonomous: true
user_setup:
  - service: telegram
    why: "Bot needs to call Telegram Bot API directly to send polls and messages"
    env_vars:
      - name: telegram_bot_token
        source: "BotFather on Telegram -> /mybots -> select bot -> API Token"
      - name: telegram_chat_id
        source: "Add bot to group chat, send a message, call getUpdates API to find chat ID"
      - name: telegram_user_ids
        source: "Object mapping user names to Telegram user IDs (e.g. {\"greg\": 123456, \"danielle\": 789012}). Get IDs from getUpdates API response after each user sends a message in the group."

must_haves:
  truths:
    - "Bot can send a native Telegram poll to the group chat via the task system"
    - "Poll state (poll ID, chat ID, message ID, question, options, votes, status) is persisted to a JSON file"
    - "Bot can stop/close an active poll via the task system"
    - "Poll task is registered in the task registry and callable via node tasks/index.js"
  artifacts:
    - path: "tasks/poll/helpers/telegram-api.js"
      provides: "Shared Telegram Bot API HTTP helper (sendPoll, stopPoll, sendMessage)"
      contains: "telegramRequest"
    - path: "tasks/poll/helpers/send-poll.js"
      provides: "Helper that sends a poll and persists initial state"
      contains: "sendPoll"
    - path: "tasks/poll/helpers/poll-state.js"
      provides: "Poll state read/write/update using JSON file in memory/"
      contains: "loadPollState"
    - path: "tasks/poll/config.js"
      provides: "Task config for poll module with intents and helpers"
      contains: "task: 'poll'"
    - path: "tasks/index.js"
      provides: "Updated registry with poll task"
      contains: "poll: require('./poll/config')"
  key_links:
    - from: "tasks/poll/config.js"
      to: "tasks/poll/helpers/send-poll.js"
      via: "helpers map references sendPoll function"
      pattern: "helpers.*sendPoll"
    - from: "tasks/poll/helpers/send-poll.js"
      to: "tasks/poll/helpers/telegram-api.js"
      via: "imports telegramRequest for API call"
      pattern: "require.*telegram-api"
    - from: "tasks/poll/helpers/send-poll.js"
      to: "tasks/poll/helpers/poll-state.js"
      via: "saves poll state after sending"
      pattern: "require.*poll-state"
    - from: "tasks/index.js"
      to: "tasks/poll/config.js"
      via: "registry entry"
      pattern: "poll.*require.*poll/config"
---

<objective>
Create the poll task module with Telegram Bot API integration and poll state management.

Purpose: Establish the foundational infrastructure for sending Telegram native polls from the task system, including API communication, state persistence, and task registration. This module will be consumed by Plan 02 for vote monitoring and tie-break logic.

Output: A working `poll` task with `create` and `stop` intents callable via `node tasks/index.js "poll create ..."`.
</objective>

<execution_context>
@/Users/greg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/greg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tasks/orchestrator.js
@tasks/types.js
@tasks/index.js
@tasks/read-msg.js
@tasks/weather/config.js
@tasks/weather/helpers/get-weather.js
@tasks/todoist/helpers/todoist-api.js
@credentials.json.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Telegram Bot API helper and poll state module</name>
  <files>
    tasks/poll/helpers/telegram-api.js
    tasks/poll/helpers/poll-state.js
    credentials.json.example
  </files>
  <action>
Create `tasks/poll/helpers/telegram-api.js` — a shared Telegram Bot API HTTP helper following the same pattern as `tasks/todoist/helpers/todoist-api.js` (built-in `https` module, no npm dependencies).

**Credential loading (`loadTelegramCredentials`):**
- Check `process.env.TELEGRAM_BOT_TOKEN` first, then fall back to `credentials.json` field `telegram_bot_token`
- Also load `telegram_chat_id` (the group chat ID where polls are sent) and `telegram_user_ids` (object mapping names to Telegram user IDs, e.g. `{"greg": 123, "danielle": 456}`)
- Throw clear error if token or chat_id missing

**HTTP helper (`telegramRequest(method, botToken, body)`):**
- Makes HTTPS POST to `https://api.telegram.org/bot{token}/{method}`
- Accepts method name (e.g. `sendPoll`, `stopPoll`, `sendMessage`), bot token, and request body object
- Returns parsed JSON response
- Throws on HTTP errors or non-`ok` responses
- Follow the same promise-based pattern as `todoist-api.js` `todoistRequest()`

**Convenience functions:**
- `sendPoll(botToken, chatId, question, options)` — calls `telegramRequest('sendPoll', ...)` with `is_anonymous: false`, `type: 'regular'`, `allows_multiple_answers: false`. Returns the full API response (contains `result.poll.id`, `result.message_id`, etc.)
- `stopPoll(botToken, chatId, messageId)` — calls `telegramRequest('stopPoll', ...)` with `chat_id` and `message_id`. Returns the stopped poll result.
- `sendMessage(botToken, chatId, text)` — calls `telegramRequest('sendMessage', ...)`. For tie-break announcements. Returns message result.

Create `tasks/poll/helpers/poll-state.js` — manages active poll state in `memory/poll-state.json`.

**State file structure:**
```json
{
  "activePoll": {
    "pollId": "string",
    "messageId": 12345,
    "chatId": -100123,
    "question": "What's for dinner?",
    "options": ["Tacos", "Pizza", "Sushi"],
    "votes": {},
    "createdAt": "2026-02-16T20:00:00.000Z",
    "timeoutMinutes": 60,
    "status": "open"
  }
}
```

The `votes` object maps Telegram user ID (string) to the option index they chose: `{"123": 0, "456": 1}`.

**Functions:**
- `loadPollState()` — reads `memory/poll-state.json`, returns parsed object. If file missing or empty, returns `{ activePoll: null }`.
- `savePollState(state)` — writes state to `memory/poll-state.json` with `JSON.stringify(state, null, 2)`.
- `hasActivePoll()` — returns boolean, true if `activePoll` is non-null and `status === 'open'`.
- `clearActivePoll()` — sets `activePoll` to null and saves.

Use `path.join(__dirname, '..', '..', '..', 'memory', 'poll-state.json')` for the file path (same depth as weather/todoist credentials pattern).

Update `credentials.json.example` to add:
```json
"telegram_bot_token": "",
"telegram_chat_id": "",
"telegram_user_ids": {
  "greg": "",
  "danielle": ""
}
```
  </action>
  <verify>
Run `node -e "const t = require('./tasks/poll/helpers/telegram-api'); console.log(typeof t.loadTelegramCredentials, typeof t.sendPoll, typeof t.stopPoll, typeof t.sendMessage)"` — should print `function function function function`.

Run `node -e "const s = require('./tasks/poll/helpers/poll-state'); console.log(typeof s.loadPollState, typeof s.savePollState, typeof s.hasActivePoll, typeof s.clearActivePoll)"` — should print `function function function function`.

Verify `credentials.json.example` contains `telegram_bot_token`, `telegram_chat_id`, and `telegram_user_ids` fields.
  </verify>
  <done>
Telegram API helper exports loadTelegramCredentials, telegramRequest, sendPoll, stopPoll, sendMessage. Poll state module exports loadPollState, savePollState, hasActivePoll, clearActivePoll. credentials.json.example updated with Telegram fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create poll task config with create and stop intents, register in task system</name>
  <files>
    tasks/poll/helpers/send-poll.js
    tasks/poll/config.js
    tasks/index.js
  </files>
  <action>
Create `tasks/poll/helpers/send-poll.js` — the helper function for the `create` intent.

**`sendPollHelper(parameters, context)` function:**
1. Load credentials via `loadTelegramCredentials()`
2. Check `hasActivePoll()` — if true, throw error "A poll is already active. Close it first or wait for it to finish."
3. Extract `parameters.question` (string) and `parameters.options` (comma-separated string, e.g. "Tacos,Pizza,Sushi")
4. Split options by comma, trim whitespace, filter empty strings
5. Validate 2-4 options (per user decision). Throw if outside range.
6. Call `sendPoll(botToken, chatId, question, optionsArray)`
7. On success, save poll state via `savePollState()`:
   - `pollId`: from `response.result.poll.id`
   - `messageId`: from `response.result.message_id`
   - `chatId`: from credentials
   - `question`: the question text
   - `options`: the options array
   - `votes`: empty object `{}`
   - `createdAt`: `new Date().toISOString()`
   - `timeoutMinutes`: `parameters.timeout` or default `60` (Claude's discretion: 60 min default timeout)
   - `status`: `"open"`
8. Return structured data: `{ pollId, messageId, question, options, timeoutMinutes }`

Create `tasks/poll/helpers/stop-poll-helper.js` — the helper function for the `stop` intent.

**`stopPollHelper(parameters, context)` function:**
1. Load credentials and poll state
2. If no active poll, throw error "No active poll to stop."
3. Call `stopPoll(botToken, state.activePoll.chatId, state.activePoll.messageId)`
4. Call `clearActivePoll()` to clean up state
5. Return `{ stopped: true, question: state.activePoll.question }`

Create `tasks/poll/config.js` following the exact pattern of `tasks/weather/config.js` and `tasks/todoist/config.js`:

```javascript
module.exports = {
  task: 'poll',
  intents: {
    'create': {
      helpers: ['sendPoll'],
      validate: (params) => {
        if (!params.question) return 'question is required to create a poll';
        if (!params.options) return 'options is required (comma-separated, 2-4 choices)';
        return null;
      }
    },
    'stop': {
      helpers: ['stopPoll']
    }
  },
  helpers: {
    'sendPoll': sendPollHelper,
    'stopPoll': stopPollHelper
  }
  // No cache config — polls are mutations, not cacheable queries
};
```

Update `tasks/index.js` registry to add:
```javascript
poll: require('./poll/config'),
```

Add it after the `todoist` entry in the registry object.
  </action>
  <verify>
Run `node -e "const c = require('./tasks/poll/config'); console.log(c.task, Object.keys(c.intents).join(','), Object.keys(c.helpers).join(','))"` — should print `poll create,stop sendPoll,stopPoll`.

Run `node tasks/index.js "poll create question=Test options=A,B"` — should fail with a credentials error (expected, since no real token configured), confirming the full pipeline (registry -> runner -> validation -> helper) is wired. The error message should mention `telegram_bot_token`.

Run `node -e "const idx = require('./tasks/index'); console.log('poll' in require('./tasks/index') || 'runTask' in idx)"` — should confirm module loads without errors.
  </verify>
  <done>
Poll task module is complete with `create` and `stop` intents. Task is registered in the task system. Running `node tasks/index.js "poll create question=... options=..."` reaches the Telegram API helper (fails gracefully without credentials). Poll state is saved to `memory/poll-state.json` on successful poll creation.
  </done>
</task>

</tasks>

<verification>
1. All files exist: `tasks/poll/config.js`, `tasks/poll/helpers/telegram-api.js`, `tasks/poll/helpers/send-poll.js`, `tasks/poll/helpers/stop-poll-helper.js`, `tasks/poll/helpers/poll-state.js`
2. `tasks/index.js` registry includes `poll` entry
3. `credentials.json.example` has Telegram fields
4. `node tasks/index.js "poll create question=Test options=A,B"` runs without module errors (credential error is expected)
5. `node tasks/index.js "poll stop"` runs without module errors
6. No npm dependencies added — uses only built-in `https`, `fs`, `path` modules
</verification>

<success_criteria>
The poll task module is fully wired into the task system with create and stop intents. All helpers use built-in Node.js modules only. Poll state persists to a JSON file. The module is ready to be extended with vote processing and tie-break logic in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/02-add-the-ability-for-the-bot-to-create-a-telegram-poll/02-01-SUMMARY.md`
</output>
