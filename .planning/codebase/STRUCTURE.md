# Codebase Structure

**Analysis Date:** 2026-02-09

## Directory Layout

```
/Users/greg/ai/assistant/workspace-fixed/
├── .planning/                    # Planning and documentation
│   └── codebase/                # Codebase analysis documents
├── calendar/                     # Google Calendar CLI integration
│   ├── calendar.js              # Main calendar CLI tool
│   ├── setup.js                 # Interactive setup wizard
│   ├── config.json              # Calendar ID + timezone (generated)
│   ├── credentials.json         # Google service account key (secret, generated)
│   ├── package.json             # Node.js dependencies
│   ├── package-lock.json        # Locked dependency versions
│   ├── README.md                # Complete setup guide
│   └── AGENT_INSTRUCTIONS.md    # Critical timezone + usage notes
├── household/                    # Household state management
│   ├── state/                   # State configuration
│   │   ├── config.json          # Telegram command mappings
│   │   ├── google-calendar-key.json  # Calendar credentials backup
│   │   ├── calendar-id.txt      # Calendar ID reference
│   │   └── sync-state.json      # Sync tracking state
│   ├── meals/                   # Meal planning
│   │   ├── this-week.md         # Weekly meal plan
│   │   └── recipes/             # Recipe storage (currently empty)
│   ├── todos.md                 # Task list (checkboxes)
│   ├── shopping.md              # Shopping list
│   ├── notes.md                 # Quick notes
│   ├── bills.md                 # Bills tracker
│   ├── maintenance.md           # Home maintenance log
│   ├── calendar.md              # Local event notes (non-Google)
│   └── (future: recipes/, finance/, etc.)
├── SOUL.md                       # Agent personality + boundaries
├── IDENTITY.md                   # Agent identity template (incomplete)
├── USER.md                       # User profile template (incomplete)
├── AGENTS.md                     # Agent guidelines + memory protocol
├── TOOLS.md                      # Household assistant configuration
├── HEARTBEAT.md                  # Proactive check schedule
├── BOOTSTRAP.md                  # First-run initialization (starter)
└── README.md                     # (workspace root)
```

## Directory Purposes

**`calendar/`:**
- Purpose: Google Calendar integration as a standalone Node.js CLI
- Contains: JavaScript CLI tool, setup wizard, config files, dependencies
- Key files: `calendar/calendar.js` (main), `calendar/setup.js` (setup)
- Access pattern: Invoked via `node calendar.js [command]` from shell or external agents
- No external API except Google Calendar v3

**`household/`:**
- Purpose: Household state management and human-readable task tracking
- Contains: Markdown files for todos, shopping, bills, notes, meal plans
- Key files: `todos.md`, `shopping.md`, `meals/this-week.md`
- Access pattern: Read/write via agents or manual editing; markdown checkbox syntax for state
- No code execution; pure data storage

**`household/state/`:**
- Purpose: Configuration and sync state for household subsystem
- Contains: Command mappings for Telegram bot, calendar credentials, sync tracking
- Key files: `config.json` (Telegram command handlers), `sync-state.json` (last sync time)
- Access pattern: Read by agents to understand command routing; written by sync processes
- Format: JSON configuration files

**`household/meals/`:**
- Purpose: Meal planning and recipe storage
- Contains: Weekly meal plan, recipe directory
- Key files: `this-week.md` (current meal plan)
- Access pattern: Read for "what's for dinner?"; updated weekly
- Format: Markdown for readability, recipes folder reserved for future expansion

**`.planning/codebase/`:**
- Purpose: Architecture and structure documentation generated by codebase analysis
- Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md, STACK.md, INTEGRATIONS.md
- Access pattern: Read-only reference for agents implementing features
- Auto-generated; do not edit manually

**Root workspace files:**
- `SOUL.md`: Agent personality definition and ethical boundaries
- `IDENTITY.md`: Agent identity metadata (incomplete template)
- `USER.md`: User profile template (incomplete)
- `AGENTS.md`: Agent protocol for memory, heartbeats, group chat behavior
- `TOOLS.md`: Household assistant configuration and command reference
- `HEARTBEAT.md`: Proactive checking schedule (currently just reference)
- `BOOTSTRAP.md`: First-run initialization guide (delete after setup complete)

## Key File Locations

**Entry Points:**

- `calendar/calendar.js`: Main calendar CLI — invoked as `node calendar.js [command]`
  - Purpose: List/create/update/delete calendar events with Pacific timezone handling
  - Lines 295-409: Command dispatcher and main execution

- `calendar/setup.js`: One-time setup wizard — run once to generate config.json
  - Purpose: Validate credentials, prompt for calendar ID, save configuration
  - Lines 21-70: Interactive setup logic

**Configuration:**

- `calendar/config.json`: Calendar ID and timezone settings
  - Schema: `{"calendarId": "...", "timeZone": "..."}`
  - Format: JSON
  - Example: `{"calendarId": "danielle.demarchi@gmail.com", "timeZone": "America/Los_Angeles"}`

- `household/state/config.json`: Telegram command mappings
  - Schema: `{"platform": "telegram", "commands": {...}}`
  - Format: JSON
  - Maps user input patterns to internal commands (show todos, add task, etc.)

- `TOOLS.md`: Configuration reference for agents
  - Calendar commands, timezone rules, household markdown file purposes
  - Lines 1-118: Complete reference

**Core Logic:**

- `calendar/calendar.js`: All calendar business logic
  - Lines 8-12: Timezone configuration
  - Lines 19-39: Config and auth loading
  - Lines 44-177: Timezone conversion utilities
  - Lines 199-291: Core CRUD operations (listEvents, createEvent, deleteEvent, updateEvent)
  - Lines 295-409: CLI command dispatcher

- `household/*.md`: State files (todos, shopping, notes, bills, maintenance, calendar, meals/this-week)
  - Purpose: Human-readable state storage; agents read/write as needed
  - Format: Markdown with task checkboxes (`- [ ]` for incomplete, `- [x]` for done)
  - No schema validation; agents responsible for preserving format

**Testing:**

- No test files present — testing is manual or via agent validation
- Agent instructions in `calendar/AGENT_INSTRUCTIONS.md` and `TOOLS.md` serve as acceptance criteria

## Naming Conventions

**Files:**

- **Node.js scripts:** `camelCase.js` (e.g., `calendar.js`, `setup.js`)
- **Configuration:** `kebab-case.json` or `camelCase.json` (e.g., `config.json`, `package.json`)
- **Documentation:** `UPPERCASE.md` (e.g., `SOUL.md`, `AGENTS.md`, `BOOTSTRAP.md`)
- **Markdown state files:** `kebab-case.md` (e.g., `todos.md`, `shopping.md`, `this-week.md`)
- **Credentials:** `credentials.json`, `google-calendar-key.json` (secrets; git-ignored)

**Directories:**

- **Feature domains:** lowercase plural nouns (e.g., `calendar`, `household`, `meals`, `state`)
- **System directories:** dot prefix for hidden (e.g., `.planning`)
- **Nested domains:** lowercase nested under parent (e.g., `household/meals/`, `household/state/`)

**Functions (in calendar.js):**

- **Utilities:** camelCase, verb-first (e.g., `loadConfig()`, `getAuthClient()`, `nowInPacific()`)
- **Formatters:** `format[Type]()` (e.g., `formatPacific()`, `formatPacificDate()`)
- **Converters:** `[Source]To[Target]()` (e.g., `pacificMidnightToUTC()`)
- **Boundary calculators:** `[Time]Bounds()` (e.g., `todayBounds()`, `thisWeekBounds()`, `nextNDaysBounds()`)

**Variables:**

- **Times:** camelCase, timezone-aware names (e.g., `pacificDate`, `utcTime`)
- **Config:** camelCase (e.g., `calendarId`, `timeZone`)
- **Objects:** camelCase (e.g., `eventData`, `params`, `config`)

## Where to Add New Code

**New Calendar Feature (e.g., recurring events, search):**
- Implementation: Add command handler to `calendar/calendar.js` switch statement (after line 303)
- Utility functions: Add to timezone/helper section (lines 17-195)
- CLI parsing: Update help text (lines 392-407)
- Example: To add `recurrence` command, add case before default, implement function similar to `listEvents()`, update help

**New Household Module (e.g., budget tracking, shopping analytics):**
- State file: Create `household/[feature].md` (e.g., `household/budget.md`)
- Configuration: Update `household/state/config.json` with new command mappings
- Agent integration: Document command handlers in `TOOLS.md`
- Access: Agents read/write file directly; no code execution needed
- Example: For budgeting, create `household/budget.md` with monthly entries, agents parse and format for display

**New Meal Planning Feature (e.g., grocery auto-list):**
- Implementation: Add to `household/meals/` as new `.md` file
- Configuration: Update `household/state/config.json` command mappings
- Integration: Reference from `TOOLS.md` household command handlers
- Example: Create `household/meals/ingredients.md` as index; agents cross-reference recipes with shopping list

**New Agent Integration Point:**
- Configuration: Add entry to `household/state/config.json` commands
- Documentation: Update `TOOLS.md` with command syntax and examples
- Testing: Run through agent instructions from `AGENT_INSTRUCTIONS.md` and `TOOLS.md`

**Setup or Initial Configuration:**
- Wizard: Modify `calendar/setup.js` if new config required
- Reference: Update `TOOLS.md` with new settings and defaults
- Docs: Add to `README.md` setup steps

## Special Directories

**`.planning/codebase/`:**
- Purpose: Auto-generated codebase analysis documents
- Generated: By `/gsd:map-codebase` command
- Committed: Yes (part of codebase reference)
- Editable: No (auto-regenerated)

**`household/state/`:**
- Purpose: Configuration and state tracking for household subsystem
- Generated: No (manually created)
- Committed: Yes (necessary for operation)
- Editable: Yes (by agents and setup scripts)

**`household/meals/recipes/`:**
- Purpose: Recipe storage (reserved for future use)
- Generated: No
- Committed: No (currently empty with `.empty` marker)
- Editable: Yes (will be populated with recipe markdown files)

**`calendar/node_modules/`:**
- Purpose: NPM dependency storage
- Generated: Yes (by `npm install`)
- Committed: No (in .gitignore)
- Editable: No (auto-managed by npm)

## Rules for Modification

**Calendar CLI (`calendar/calendar.js`):**
- Changes are backward-compatible — existing commands must not break
- Timezone logic is CRITICAL — never refactor timezone functions without thorough testing
- Agent instructions (`AGENT_INSTRUCTIONS.md`, `TOOLS.md`) must be updated when command behavior changes
- Config format changes require corresponding updates to setup.js

**Household Markdown Files:**
- Agents must preserve markdown format when reading/writing
- Task checkboxes (`- [ ]` / `- [x]`) must be preserved exactly
- Timestamp format in notes should be ISO 8601 with Pacific timezone indicator
- No schema validation — agents responsible for format preservation

**Configuration Files:**
- Never commit `credentials.json` or `google-calendar-key.json`
- Changes to command mappings in `household/state/config.json` must be documented in `TOOLS.md`
- Calendar ID changes require re-running `calendar/setup.js`

---

*Structure analysis: 2026-02-09*
